<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Sem√°foros NIOS II</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #efefef;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .control-panel {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .semaphore-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }

        .semaphore-group h3 {
            color: #4800ff;
            margin-bottom: 15px;
            border-bottom: 2px solid #4800ff;
            padding-bottom: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #4800ff;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-process {
            background-color: #4800ff;
            color: white;
        }

        .btn-process:hover:not(:disabled) {
            background-color: #3b00cf;
        }

        .btn-start {
            background-color: #4CAF50;
            color: white;
        }

        .btn-start:hover:not(:disabled) {
            background-color: #45a049;
        }

        .btn-stop {
            background-color: #ff0000;
            color: white;
        }

        .btn-stop:hover:not(:disabled) {
            background-color: #dd0000;
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 15px;
            color: #4800ff;
            font-weight: bold;
        }

        #sim {
            width: 640px;
            height: 360px;
            display: block;
            position: relative;
            background: black;
            border: 2px solid black;
            margin: 10px auto;
            overflow: hidden;
        }

        #sim > * {
            position: absolute;
        }

        #light-1, #light-2 {
            display: inline-block;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: red;
            background-image: url(images/traffic-lights.svg);
            border: 3px solid transparent;
        }

        #sim[data-light="0"] #light-1, #sim[data-light="0"] #light-2 {
            background-color: gray !important;
        }

        #sim[data-light="1"] #light-1 {
            background-color: green;
        }

        #sim[data-light="2"] #light-2 {
            background-color: green;
        }

        #sim[data-light="1"][data-yellow="true"] #light-1 {
            background-color: yellow;
        }

        #sim[data-light="2"][data-yellow="true"] #light-2 {
            background-color: yellow;
        }

        #light-1 {
            top: 75px;
            left: 120px;
        }

        #light-2 {
            top: 180px;
            right: 240px;
        }

        #intersection, #lane-1, #lane-2 {
            background: white;
        }

        #lane-1 {
            left: 180px;
            width: 50px;
            height: 100%;
        }

        #lane-2 {
            bottom: 70px;
            height: 50px;
            width: 100%;
        }

        #intersection {
            border-radius: 50%;
            width: 110px;
            height: 110px;
            top: 205px;
            left: 150px;
            display: grid;
            place-items: center center;
        }

        #sim[data-state="error"] #intersection {
            background: radial-gradient(red, transparent);
        }

        .vehicle {
            --color: black;
            --pos: 10;
            
            display: inline-block;
            width: 45px;
            height: 45px;
            margin: 2px;
            position: absolute;
            background-color: var(--color);
            background-position: center;
            background-repeat: no-repeat;
            will-change: transform;
            transition: transform 0.3s;
            transform: translate(
                calc((var(--pos) + 1.5) * var(--delta-x) * 1px),
                calc((var(--pos) + 1.5) * var(--delta-y) * 1px)
            ) rotateY(var(--rotate-y)) rotateZ(var(--rotate-z));
        }

        .vehicle.car { 
            background-image: url(images/city-car.svg); 
        }

        .vehicle.truck { 
            background-image: url(images/truck.svg); 
        }

        #sim[data-state="error"] .vehicle[data-state="leaving"] {
            --pos: -1.5 !important;
            position: static;
            animation: none;
        }

        .vehicle.west {
            --rotate-y: 180deg;
            --rotate-z: 0deg;
            --delta-x: 50;
            --delta-y: 0;
        }

        .vehicle.south {
            --rotate-y: 0deg;
            --rotate-z: 90deg;
            --delta-x: 0;
            --delta-y: -50;
        }

        .vehicle[data-state="leaving"] {
            animation: 1.5s vehicle-leave ease-in forwards;
        }

        @keyframes vehicle-leave {
            0% {
                opacity: 1;
                transform: translate(
                    calc((var(--pos) + 1.5) * var(--delta-x) * 1px),
                    calc((var(--pos) + 1.5) * var(--delta-y) * 1px)
                ) rotateY(var(--rotate-y)) rotateZ(var(--rotate-z));
            }
            75% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translate(
                    calc(var(--delta-x) * -2.5px),
                    calc(var(--delta-y) * -1.5px)
                ) rotateY(var(--rotate-y)) rotateZ(var(--rotate-z));
            }
        }

        .status-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .status-item {
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .status-item h4 {
            color: #4800ff;
            margin-bottom: 10px;
        }

        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .reference-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .semaphore-config {
                grid-template-columns: 1fr;
            }
            .button-group {
                grid-template-columns: 1fr;
            }
            #sim {
                width: 100%;
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö¶ Controle de Sem√°foros NIOS II</h1>

        <div class="control-panel">
            <form id="stringForm">
                <div class="semaphore-config">
                    <div class="semaphore-group">
                        <h3>Sem√°foro 0 (Vertical)</h3>
                        <div class="form-group">
                            <label for="inputTimeRed0">üî¥ Tempo Vermelho (s):</label>
                            <input type="number" id="inputTimeRed0" value="15" min="1" max="999" required>
                        </div>
                        <div class="form-group">
                            <label for="inputTimeYellow0">üü° Tempo Amarelo (s):</label>
                            <input type="number" id="inputTimeYellow0" value="3" min="1" max="999" required>
                        </div>
                        <div class="form-group">
                            <label for="inputTimeGreen0">üü¢ Tempo Verde (s):</label>
                            <input type="number" id="inputTimeGreen0" value="12" min="1" max="999" required>
                        </div>
                    </div>

                    <div class="semaphore-group">
                        <h3>Sem√°foro 1 (Horizontal)</h3>
                        <div class="form-group">
                            <label for="inputTimeRed1">üî¥ Tempo Vermelho (s):</label>
                            <input type="number" id="inputTimeRed1" value="15" min="1" max="999" required>
                        </div>
                        <div class="form-group">
                            <label for="inputTimeYellow1">üü° Tempo Amarelo (s):</label>
                            <input type="number" id="inputTimeYellow1" value="3" min="1" max="999" required>
                        </div>
                        <div class="form-group">
                            <label for="inputTimeGreen1">üü¢ Tempo Verde (s):</label>
                            <input type="number" id="inputTimeGreen1" value="12" min="1" max="999" required>
                            <input type="number" id="inputTimeGreen1" value="12" min="1" max="999" required>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="initialStateSelector">üö• Estado Inicial do Sem√°foro 0 (Vertical):</label>
                    <label for="initialStateSelector">üö• Estado Inicial do Sem√°foro 0 (Vertical):</label>
                    <select id="initialStateSelector" required>
                        <option value="R">üî¥ Vermelho</option>
                        <option value="Y">üü° Amarelo</option>
                        <option value="G">üü¢ Verde</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="dynamicTimes">
                        ‚è±Ô∏è Usar tempos din√¢micos (baseado no fluxo)
                    </label>
                </div>


                <div class="form-group">
                    <label>
                        <input type="checkbox" id="dynamicTimes">
                        ‚è±Ô∏è Usar tempos din√¢micos (baseado no fluxo)
                    </label>
                </div>


                <div class="button-group">
                    <button type="submit" class="btn-process">Enviar para NIOS</button>
                    <button type="button" id="btnStart" class="btn-start">‚ñ∂Ô∏è Iniciar Simula√ß√£o</button>
                    <button type="button" id="btnStop" class="btn-stop" disabled>‚èπÔ∏è Parar</button>
                </div>
            </form>

            <div class="loading" id="loading">
                <p>‚è≥ Processando comando...</p>
            </div>

            <div class="result" id="result"></div>
        </div>

        <div id="sim" data-light="0" data-state="normal" data-yellow="false">
            <span id="light-1" title="Sem√°foro 0 (Vertical)"></span>
            <span id="light-2" title="Sem√°foro 1 (Horizontal)"></span>
            <div id="lane-1" title="Via Vertical"></div>
            <div id="lane-2" title="Via Horizontal"></div>
            <div id="intersection" title="Interse√ß√£o"></div>
        </div>

        <div class="status-panel">
            <h3>üìä Status da Simula√ß√£o</h3>
            <div class="status-grid">
                <div class="status-item">
                    <h4>üöó Ve√≠culos Via Vertical</h4>
                    <div class="status-value" id="countSouth">0</div>
                </div>
                <div class="status-item">
                    <h4>üöô Ve√≠culos Via Horizontal</h4>
                    <div class="status-value" id="countWest">0</div>
                </div>
            </div>
        </div>

        <div class="reference-panel">
            <section>
                <h3>Refer√™ncias</h3>
                <p>√çcones de 'City car', 'Truck' e 'Traffic lights' por <a href="http://delapouite.com">Delapouite</a></p>
                <p>O <a href="https://github.com/djalilhebal/softvis-traffic-semaphores">c√≥digo</a> de @djalilhebal inspirou a parte do simulador deste projeto.</p>
            </section>
        </div>
    </div>

    <script>
        // ===== SEM√ÅFORO SIMPLIFICADO =====
        class SimpleSemaphore {
            constructor(permits) {
                this.permits = permits;
                this.queue = [];
            }

            async acquire(acquirer) {
                return new Promise((resolve) => {
                    this.queue.push({ acquirer, resolve });
                    this.maybeNotify();
                });
            }

            release() {
                this.permits++;
                this.maybeNotify();
            }

            maybeNotify() {
                if (this.permits > 0 && this.queue.length > 0) {
                    const entry = this.queue.shift();
                    this.permits--;
                    entry.resolve();
                }
            }

            reset(permits = 0) {
                this.permits = permits;
                this.maybeNotify();
            }


        }

        // ===== CONFIGURA√á√ÉO GLOBAL =====

        const USE_NIOS_AS_MASTER = true;

        const config = {
            baseTimes: {
                sem0: { red: 15, yellow: 3, green: 12 },
                sem1: { red: 15, yellow: 3, green: 12 }
                sem0: { red: 15, yellow: 3, green: 12 },
                sem1: { red: 15, yellow: 3, green: 12 }
            },
            dynamic: false,
            minGreen: 5,
            maxGreen: 25,
            dynamic: false,
            minGreen: 5,
            maxGreen: 25,
            running: false,
            light: 1,
            phase: 'GREEN' // 'GREEN' | 'YELLOW'
            light: 1,
            phase: 'GREEN' // 'GREEN' | 'YELLOW'
        };

        // ===== SEM√ÅFOROS DE CONTROLE =====
        const sLight1 = new SimpleSemaphore(1);
        const sLight2 = new SimpleSemaphore(0);
        const sEmpty1 = new SimpleSemaphore(1);
        const sEmpty2 = new SimpleSemaphore(1);

        // ===== ELEMENTOS DOM =====
        const ui = {
            btnStart: document.getElementById('btnStart'),
            btnStop: document.getElementById('btnStop'),
            sim: document.getElementById('sim'),
            intersection: document.getElementById('intersection'),
            countSouth: document.getElementById('countSouth'),
            countWest: document.getElementById('countWest'),
            result: document.getElementById('result'),
            loading: document.getElementById('loading')
        };

        // ===== ESTADO DA SIMULA√á√ÉO =====
        let lane1 = [];
        let lane2 = [];
        let crossing = 0;
        let vehicleCounter = 0;
        let creatorInterval = null;
        let controllerRunning = false;
        let freeColors = ['blue', 'coral', 'darkkhaki', 'firebrick', 'yellowgreen', 
                          'gray', 'skyblue', 'teal', 'orange', 'pink', 'purple', 'yellow'];

        // ===== FUN√á√ïES AUXILIARES =====
        function sleep(seconds) {
            return new Promise(resolve => setTimeout(resolve, seconds * 1000));
        }

        function padNumber(num) {
            return String(num).padStart(3, '0');
        }

        function showMessage(type, message) {
            ui.result.className = `result ${type}`;
            ui.result.innerHTML = message;
            ui.result.style.display = 'block';
        }

        function updateCounts() {
            ui.countSouth.textContent = lane1.length;
            ui.countWest.textContent = lane2.length;
        }

        function getDynamicGreenTime() {
            const cars =
                config.light === 1 ? lane1.length : lane2.length;

            // Cada carro adiciona 1.5s
            let green = config.minGreen + cars * 1.5;

            return Math.min(config.maxGreen, Math.max(config.minGreen, green));
        }


        // ===== CLASSE VE√çCULO =====
        class Vehicle {
            constructor(lane, direction) {
                this.id = ++vehicleCounter;
                this.lane = lane;
                this.direction = direction;
                this.color = this.getUniqueColor();
                this.type = Math.random() < 0.25 ? 'truck' : 'car';
                this.element = this.createElement();
            }

            getUniqueColor() {
                if (freeColors.length === 0) {
                    // Se acabaram as cores, gera uma cor aleat√≥ria
                    const r = Math.floor(Math.random() * 200 + 55);
                    const g = Math.floor(Math.random() * 200 + 55);
                    const b = Math.floor(Math.random() * 200 + 55);
                    return `rgb(${r}, ${g}, ${b})`;
                }
                return freeColors.shift();
            }

            createElement() {
                const el = document.createElement('div');
                el.className = `vehicle ${this.type} ${this.direction}`;
                el.style.setProperty('--color', this.color);
                el.style.setProperty('--pos', this.lane === 1 ? '4' : '7');
                el.title = `Ve√≠culo #${this.id}`;
                ui.intersection.appendChild(el);
                return el;
            }

            async run() {
                try {
                    if (this.lane === 1) {
                        await sLight1.acquire(this);

                        while (!canPass(1) || lane1[0] !== this) {
                            sLight1.release();
                            await sleep(0.1);
                            await sLight1.acquire(this);
                        }

                        await this.traverse();
                        sLight1.release();

                    } else {
                        await sLight2.acquire(this);

                    while (!canPass(2) || lane2[0] !== this) {
                        sLight2.release();
                        await sleep(0.1);
                        await sLight2.acquire(this);
                    }


                    await this.traverse();
                    sLight2.release();

                    }
                } catch (error) {
                    console.error('Erro no ve√≠culo:', error);
                }
            }

            async traverse() {
                if (!config.running) return;
                
                await sleep(Math.random() * 0.5);
                await this.enterIntersection();
                await this.leaveIntersection();
            }

            async enterIntersection() {
                crossing++;
                this.element.dataset.state = 'leaving';
                
                if (crossing > 1) {
                    ui.sim.dataset.state = 'error';
                    showMessage('error', '<strong>COLIS√ÉO DETECTADA!</strong> A simula√ß√£o foi interrompida.');
                    stop();
                    return;
                }
                
                await sleep(0.5);
            }

            async leaveIntersection() {
                await sleep(1);
                this.destroy();
                crossing--;
            }

            destroy() {
                this.element.remove();
                // S√≥ devolve a cor se for uma das cores originais
                if (!this.color.startsWith('rgb(')) {
                    freeColors.push(this.color);
                }
                const targetLane = this.lane === 1 ? lane1 : lane2;
                const index = targetLane.indexOf(this);
                if (index > -1) {
                    targetLane.splice(index, 1);
                }
                updateCounts();
            }
        }

        // ===== CONTROLADOR DE SEM√ÅFOROS =====
        async function trafficController() {
            if (USE_NIOS_AS_MASTER) return;
            controllerRunning = true;
            
            while (config.running && controllerRunning) {
            const currentSemTimes = config.light === 1
                ? config.baseTimes.sem0
                : config.baseTimes.sem1;

            /* ===== FASE VERDE ===== */
            if (config.phase === 'GREEN') {
                ui.sim.dataset.yellow = 'false';
                
                const greenTime = config.dynamic
                    ? getDynamicGreenTime()
                    : currentSemTimes.green;

                await sleep(greenTime);


                if (!config.running) break;
                config.phase = 'YELLOW';
            }

            /* ===== FASE AMARELA ===== */
            if (config.phase === 'YELLOW') {
                ui.sim.dataset.yellow = 'true';
                await sleep(currentSemTimes.yellow);
                if (!config.running) break;

                /* ===== TROCA DE SEM√ÅFORO ===== */
        config.light = (config.light === 1) ? 2 : 1;
        ui.sim.dataset.light = config.light;
        syncPermits();
        config.phase = 'GREEN';
        ui.sim.dataset.yellow = 'false';
            }
        }

        }

        // ===== CRIA√á√ÉO DE VE√çCULOS =====
        function maybeCreateVehicle() {
            if (!config.running) return;
            if (Math.random() < 0.5) return;

            if (Math.random() < 0.5 && lane1.length < 4) {
                const vehicle = new Vehicle(1, 'south');
                lane1.push(vehicle);
                vehicle.run();
            } else if (lane2.length < 7) {
                const vehicle = new Vehicle(2, 'west');
                lane2.push(vehicle);
                vehicle.run();
            }

            updateCounts();
        }

        function redraw() {
            if (!config.running) return;

            lane1.forEach((v, i) => v.element.style.setProperty('--pos', i));
            lane2.forEach((v, i) => v.element.style.setProperty('--pos', i));

            requestAnimationFrame(redraw);
        }

        // ===== COMUNICA√á√ÉO COM NIOS II =====
        function buildCommandString(times) {
            const initialState = document.getElementById('initialStateSelector').value;
            return padNumber(times.sem0.red) +
                   padNumber(times.sem0.yellow) +
                   padNumber(times.sem0.green) +
                   padNumber(times.sem1.red) +
                   padNumber(times.sem1.yellow) +
                   padNumber(times.sem1.green) +
                   initialState;
        }

        // Endpoint correto do NIOS: /process (POST) e /status (GET)
        async function sendToNios(commandString) {
            try {
                const ipResponse = await fetch('http://localhost:8080/get_nios_ip');
                if (!ipResponse.ok) {
                    throw new Error('N√£o foi poss√≠vel obter o IP do NIOS');
                }
                const ipData = await ipResponse.json();
                const niosIP = ipData.ip;

                console.log(`Sending to NIOS: ${niosIP}:80/process`, commandString);

                const response = await fetch(`http://${niosIP}:80/cmd`, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain", "Content-Length": commandString.length.toString() },
                    body: commandString
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const text = await response.text();
                console.log(`NIOS response: ${text}`);
                return { success: true, response: text };

            } catch (error) {
                console.error('Erro ao enviar comando:', error);
                return { success: false, error: error.message };
            }
        }

        function syncPermits() {
            if (config.light === 1) {
                sLight1.permits = 1;
                sLight2.permits = 0;
            } else {
                sLight1.permits = 0;
                sLight2.permits = 1;
            }

            sLight1.maybeNotify();
            sLight2.maybeNotify();
        }

        function canPass(lane) {
    // s√≥ passa se for a via ativa E estiver em VERDE
    return config.light === lane && config.phase === 'GREEN';
}

        // ===== STATUS DO NIOS (polling) =====
        let statusInterval = null;
        let statusBusy = false;

        async function fetchNiosStatus() {
            if (!USE_NIOS_AS_MASTER) return;
            if (statusBusy) return;
            statusBusy = true;
            try {
                const ipResponse = await fetch('http://localhost:8080/get_nios_ip');
                if (!ipResponse.ok) return;
                const ipData = await ipResponse.json();
                const niosIP = ipData.ip;

                const response = await fetch(`http://${niosIP}:80/status`, { method: 'GET' });
                if (response.ok) {
                    const text = await response.text();
                    if (text && text.length >= 2) {
                        updateVisualizationFromNios(text[0], text[1]);
                    }
                }
            } catch (error) {
                console.error('Erro ao obter status do NIOS:', error);
            } finally {
                statusBusy = false;
            }
        }

        function updateVisualizationFromNios(sem0State, sem1State) {
            if (!config.running) return;

            const mapState = { 'R': 'RED', 'Y': 'YELLOW', 'G': 'GREEN' };
            const s0 = mapState[sem0State] || 'UNKNOWN';
            const s1 = mapState[sem1State] || 'UNKNOWN';

            console.log(`Status NIOS: Sem0=${s0}, Sem1=${s1}`);

            // ===== estado seguro padr√£o =====
            let newLight = 0;
            let newPhase = 'ALL_RED';

            if (s0 === 'GREEN') {
                newLight = 1;
                newPhase = 'GREEN';
            } else if (s0 === 'YELLOW') {
                newLight = 1;
                newPhase = 'YELLOW';
            } else if (s1 === 'GREEN') {
                newLight = 2;
                newPhase = 'GREEN';
            } else if (s1 === 'YELLOW') {
                newLight = 2;
                newPhase = 'YELLOW';
            }

            config.light = newLight;
            config.phase = newPhase;

            ui.sim.dataset.light = newLight;
            ui.sim.dataset.yellow = (newPhase === 'YELLOW').toString();

            // Se n√£o tem verde ‚Üí ningu√©m passa
            sLight1.reset(newLight === 1 ? 1 : 0);
            sLight2.reset(newLight === 2 ? 1 : 0);
        }





        // ===== CONTROLES =====
        function start() {
            stop();

            config.baseTimes.sem0.red = Number(inputTimeRed0.value);
            config.baseTimes.sem0.yellow = Number(inputTimeYellow0.value);
            config.baseTimes.sem0.green = Number(inputTimeGreen0.value);
            config.baseTimes.sem1.red = Number(inputTimeRed1.value);
            config.baseTimes.sem1.yellow = Number(inputTimeYellow1.value);
            config.baseTimes.sem1.green = Number(inputTimeGreen1.value);

            const initialState = initialStateSelector.value;

            if (initialState === 'G') {
                config.light = 1;
                config.phase = 'GREEN';
            } else if (initialState === 'Y') {
                config.light = 1;
                config.phase = 'YELLOW';
            } else {
                config.light = 2;
                config.phase = 'GREEN';
            }

            ui.sim.dataset.light = config.light;
            ui.sim.dataset.yellow = (config.phase === 'YELLOW').toString();

            config.running = true;
            controllerRunning = true;

            syncPermits();
            if (!USE_NIOS_AS_MASTER) {
                trafficController();   // s√≥ roda no modo local
            }
            redraw();
            creatorInterval = setInterval(maybeCreateVehicle, 1000);
            
            // Inicia polling de status do NIOS a cada 2 segundos
            if (statusInterval) clearInterval(statusInterval);
            statusInterval = setInterval(fetchNiosStatus, 2000);

            ui.btnStart.disabled = true;
            ui.btnStop.disabled = false;

            showMessage('success', '<strong>Simula√ß√£o iniciada!</strong>');
        }


        function stop() {
            config.running = false;
            controllerRunning = false;
            ui.btnStart.disabled = false;
            ui.btnStop.disabled = true;

            clearInterval(creatorInterval);
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
            
            sLight1.reset(1);
            sLight2.reset(0);
            sEmpty1.reset(1);
            sEmpty2.reset(1);

            
            lane1.forEach(v => v.element.remove());
            lane2.forEach(v => v.element.remove());
            lane1 = [];
            lane2 = [];
            crossing = 0;
            
            // Restaura cores dispon√≠veis
            freeColors = ['blue', 'coral', 'darkkhaki', 'firebrick', 'yellowgreen', 
                          'gray', 'skyblue', 'teal', 'orange', 'pink', 'purple', 'yellow'];
            
            ui.sim.dataset.light = 0;
            ui.sim.dataset.yellow = 'false';
            updateCounts();

            showMessage('error', '<strong>Simula√ß√£o parada</strong>');
        }

        // ===== EVENT LISTENERS =====
        document.getElementById('stringForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            config.baseTimes.sem0.red = Number(document.getElementById('inputTimeRed0').value);
            config.baseTimes.sem0.yellow = Number(document.getElementById('inputTimeYellow0').value);
            config.baseTimes.sem0.green = Number(document.getElementById('inputTimeGreen0').value);
            config.baseTimes.sem1.red = Number(document.getElementById('inputTimeRed1').value);
            config.baseTimes.sem1.yellow = Number(document.getElementById('inputTimeYellow1').value);
            config.baseTimes.sem1.green = Number(document.getElementById('inputTimeGreen1').value);

            if (Object.values(config.baseTimes.sem0).some(v => v > 999) || 
                Object.values(config.baseTimes.sem1).some(v => v > 999)) {
                showMessage('error', '<strong>Erro:</strong> Os tempos devem estar entre 1 e 999 segundos.');
                return;
            }

            ui.loading.style.display = 'block';
            ui.result.style.display = 'none';

            const commandString = buildCommandString(config.baseTimes);
            console.log('Enviando comando:', commandString);

            const result = await sendToNios(commandString);

            ui.loading.style.display = 'none';

            if (result.success) {
                showMessage('success', 
                    `<strong>Comando enviado com sucesso!</strong><br>
                    <strong>Resposta do NIOS:</strong> ${result.response}<br>
                    <strong>Comando:</strong> ${commandString}`
                );
            } else {
                showMessage('error', 
                    `<strong>Erro ao enviar comando:</strong> ${result.error}<br>
                    <small>Verifique se o servidor Python est√° rodando e se o NIOS est√° conectado.</small>`
                );
            }
        });

        ui.btnStart.addEventListener('click', start);
        ui.btnStop.addEventListener('click', stop);
        document.getElementById('dynamicTimes').addEventListener('change', e => {
            config.dynamic = e.target.checked;
        });


        // ===== INICIALIZA√á√ÉO =====
        console.log('Sistema de controle de sem√°foros inicializado');
        showMessage('success', '<strong>Sistema pronto!</strong> Configure os tempos e clique em "Enviar para NIOS" ou "Iniciar Simula√ß√£o".');
    </script>
</body>
</html>